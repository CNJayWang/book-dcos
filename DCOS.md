#DCOS
## 什么是DC/OS
DC/OS是基于Apache Mesos分布式系统内核的分布式操作系统。它使得能够管理多个机器，就像它们是单个计算机一样。它自动化资源管理，安排进程布局，促进进程间通信，并简化分布式服务的安装和管理。其包含的Web界面和可用的令行界面（CLI）便于远程管理和监控群集及其服务。

当你操作数据中心时，有一组常用的操作。在单个计算机环境中，您的操作系统自动处理这些事情。就像在你的笔记本上运行程序一样，你从来不用关心你的程序由哪个内核去运行，这都是系统自动去执行的。

在笔记本电脑上，将应用程序调度到特定核心的工作由内核处理。抽象这个过程，内核管理您的计算机上的所有资源，包括内存，磁盘，输入和输出等。没有理由内核必须只在一台计算机上运行。在多台计算机上管理资源的程序可以解决同样的问题。事实上，这是一个容器编排器。它可以像整个数据中心的组合资源的内核，而不是单个计算机的资源。

在这一点上，在某些资源上运行应用程序的行为被自动化。不幸的是，这只是一个小块的谜题。我们的现代操作系统包含大量的软件，用于解决许多其他常见的计算问题，并允许我们专注于做实际工作，而不是管理我们的计算机。DC / OS包括这些常见问题的解决方案，而在您自己研究解决方案之前，手动将它们集成到数据中心的计算机中。

### 通用管理接口 - GUI和CLI
现在不会没有GUI和CLI的计算机，我们不再在穿孔卡上编写程序了。没有理由我们应该与低级API，甚至RESTful交互，除非我们做一些高级的功能扩展的时候。
在某些时候，变得不可能作为个人与数据中心中的每个计算机进行交互。对于纯粹的理性，您必须在顶部分层抽象，并查看整个数据中心。你需要一个单一的地方来看看正在运行和运行的地方。您可以轻松地监视和调试问题，减少停机时间。没有理由SSH到数百个主机只是为了找到特定应用程序的日志。
CLI与GUI一样重要，有时不能给予它到期的信用。常规任务可以完全跳过GUI，甚至可以集成到您的正常环境中，例如VI或Emacs。对于特殊情况，CLI最终是一个很好的工具，脚本和自动化那些你不想担心的事情。

### 服务发现
写一个独立的服务并且不需要联系任何其他服务是很少的。对于三层应用程序，您需要找出如何配置中间层以联系后端数据库。在单个主机上，这可以通过端口完成。所有你需要做的是指定一个端口，假设IP地址是localhost，你准备好了。不幸的是，一旦你移动到多个主机，会出现一些问题：
		运行容器的主机IP是什么？
		如何配置客户端以连接到正确的主机IP？
		容器重新安排后，如何动态更新客户端以连接到新的主机IP？
		如何管理两个应用程序要绑定到像8080这样的常用端口？
DNS是解决方案的开始。它最初是为了在互联网的规模照顾服务发现。不幸的是，它不能很好地在一个动态改变IP的世界，因为缓存问题，一般不能解决端口。
您可以为客户端提供与容器通信的虚拟IP和端口。这种架构在内部和在每个云中工作，并将构建应用程序带回单个计算机的世界。传统和现代应用程序依赖这个简单的解决方案来完成他们的业务，而不需要任何代码更改。

### 软件包管理
应用程序往往由多个没有配置的进程组成。微服务可以由几百个进程组成，所有进程都有自己的配置。采取类似这样的方式，并将其部署在数据中心是一个耗时，微妙的过程。很容易在您的环境中误解特定配置设置的含义，或者无法使应用程序运行。
了解所有这些复杂性的一种方法是创建一个您希望在数据中心中利用的常见应用程序的包。有许多选项，如数据库和消息队列，你建立在之上。通过将进程和配置捆绑在一个包中，您可以快速开始，并确保您遵循最佳做法。

## 架构
操作系统抽象化CPU，RAM和网络等资源，并为应用程序提供通用服务。DC/OS是一个分布式操作系统，它抽象机器群集的资源并提供公共服务。这些公共服务包括跨多个节点运行进程，服务发现和包管理。本主题讨论DC/OS的架构及其组件的交互。

为了简化对DC/OS的理解，我们将重用Linux内核和用户空间的术语。内核空间是用户无法访问的保护区，涉及低级操作，如资源分配，安全性和进程隔离。用户空间是用户应用程序和高阶服务所在的位置，例如操作系统的GUI。

### 架构图解
DC/OS内核空间由Mesos主机和Mesos代理组成。用户空间包括系统组件，例如Mesos-DNS，分布式DNS代理和诸如Marathon或Spark等服务。用户空间还包括由服务管理的进程，例如Marathon应用程序。
![](https://docs.mesosphere.com/wp-content/uploads/2016/06/dcos-architecture-100000ft-4.png)
在我们深入介绍不同DC / OS组件之间的交互细节之前，让我们定义所使用的术语。
		
* Mesos Master:聚合来自所有代理节点的资源提供，并将它们提供给注册的框架。
* Scheduler程序:服务的调度程序组件，例如Marathon调度程序
* 	用户：也称为客户端，是集群内部或外部的启动过程的应用程序，例如提交Marathon应用程序规范的人类用户。
* Mesos Agent:代表一个框架运行一个离散的Mesos任务。它是向Mesos主机注册的Agent程序实例。Agent节点的同义词是工作节点或从节点。您可以拥有私人或公共代理节点
* Executor：在Agent节点上启动以运行服务的任务。
* Task：由Mesos框架计划并在Mesos Agent上执行的工作单元。
* 	Process:由客户端发起的任务的逻辑集合，例如Marathon应用程序或Metronome作业。

#### Kernel Space
在DC / OS中，内核空间管理跨集群的资源分配和两级调度。内核空间中的两种类型的进程是Mesos masters和agents:

* Mesos masters:`mesos-master`节点该进程协调在Mesos代理上运行的任务。Mesos主进程从Mesos代理接收资源报告，并将这些资源分配给注册的DC / OS服务，如Marathon或Spark。当主导Mesos主服务器由于崩溃或脱机升级失败时，备用Mesos主控器自动成为领导者而不中断正在运行的服务。动物园管理员执行领导选举

* Mesos agents: `mesos-agent`节点代表框架运行离散Mesos任务。私有Agent节点通过不可路由的网络运行部署的应用和服务。公共Agent节点在可公开访问的网络中运行DC / OS应用和服务。`mesos-slave`Mesos Agent上的进程管理其本地资源（CPU核心，RAM等），并将这些资源注册到Mesos Master。它还接受来自Mesos Master的调度请求，并调用Executor通过容器化器启动任务： 
	*  Mesos容器化程序使用特定于Linux的功能（如cgroups和命名空间）提供轻量级的容器化和执行者的资源隔离。
	* Docker容器化程序支持启动包含Docker镜像的任务。

#### User Space 
DC/OS用户空间跨越系统服务和用户服务，如Chronos或Kafka。

-  默认情况下，系统服务已安装并在DC / OS集群中运行，并包括以下内容
	* 管理路由器是一个开放源代码的NGINX配置，为DC / OS服务提供中心认证和代理
	* Exhibitor在安装过程中自动配置ZooKeeper，并为ZooKeeper提供一个可用的Web UI
	* Mesos-DNS提供服务发现，允许应用和服务通过使用域名系统（DNS）找到彼此。
	* Minuteman是内部层4负载均衡器。
	* 分布式DNS代理是内部DNS分派器
	* 	DC / OS Marathon是用于DC / OS的“init系统”的本机Marathon实例，用于启动和监视DC / OS服务。
	*  ZooKeeper，一种管理DC/OS服务的高性能协调服务。
- 用户服务
	* 	DC / OS中的用户服务由调度程序（负责代表用户调度任务）和执行程序（在Agent程序上运行任务）组成。
	*  用户级应用程序，例如通过Marathon启动的NGINX网络服务器。
	
### Distributed process management
本节介绍DC / OS集群中进程的管理，从资源分配到进程的执行。
在高级别，当用户启动进程时，在DC / OS组件之间发生这种交互。通信发生在不同层之间，例如用户与调度器交互，以及在层内，例如Mesos agent与Mesos master的通信。

![](https://docs.mesosphere.com/wp-content/uploads/2016/06/dcos-architecture-distributed-process-management-concept-4-800x504@2x.png)
这里是一个例子，使用Marathon服务和用户启动基于Docker镜像的容器：

![](https://docs.mesosphere.com/wp-content/uploads/2016/06/dcos-architecture-distributed-process-management-example-5-800x458@2x.png)

上述组件之间的时间相互作用看起来像这样。注意，Executors和Task被折叠成一个块，因为在实践中经常是这样。
![](https://docs.mesosphere.com/wp-content/uploads/2016/06/dcos-architecture-distributed-process-management-seq-diagram-4-1200x726@2x.png)

具体来说，这里是步骤：

1.  客户机/调度程序初始化：客户机需要知道如何连接到调度程序以启动一个进程，例如通过Mesos-DNS或DC/OS CLI。
2. Mesos主机向调度器发送资源提供：资源提供基于通过Agent管理的集群资源和Mesos主机中的DRF算法
3. 调度程序拒绝资源提供，因为没有来自客户端的进程请求挂起。只要没有客户端启动进程，调度程序将拒绝来自主服务器的提议。
4. 客户端启动进程启动。例如，这可以是通过DC / OS 服务选项卡或通过HTTP端点创建Marathon应用程序的用户`/v2/app`。
5. Mesos Master 发起资源邀约：例如:cpus(*):1; mem(*):128; ports(*):[21452-21452]
6. 如果资源邀约匹配调度程序对进程的要求，则它接受该邀约并向Mesos Master 发送 launchTask请求。
7. Mesos Master 指派Mesos Agent 去launch task
8. Mesos  Agent通过executor执行task
9. Executor向Agent报告task执行情况
10. Mesos Agent 将任务执行情况报告给Mesos Master
11. Mesos Master 将任务执行情况报告给Scheduler
12. Scheduler向客户端报告任务执行情况

